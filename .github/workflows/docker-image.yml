name: Build on Remote Linux Docker from Windows Runner (pwsh)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-run:
    runs-on: [self-hosted, windows, x64]  # <- your Windows runner labels
    env:
      REMOTE_DOCKER: tcp://127.0.0.1:23750
    steps:
      - uses: actions/checkout@v4

      # Ensure PowerShell 7 (pwsh) is available on the Windows runner
      - name: Install PowerShell 7 if missing
        shell: powershell
        run: |
          if (-not (Get-Command pwsh -ErrorAction SilentlyContinue)) {
            $msi = "$env:RUNNER_TEMP\pwsh.msi"
            Invoke-WebRequest -UseBasicParsing `
              -Uri https://github.com/PowerShell/PowerShell/releases/latest/download/PowerShell-7.4.4-win-x64.msi `
              -OutFile $msi
            Start-Process msiexec.exe -ArgumentList "/i `"$msi`" /qn ADD_EXPLORER_CONTEXT_MENU_OPENPOWERSHELL=0 ENABLE_PSREMOTING=0" -Wait -NoNewWindow
          }
          pwsh -NoLogo -NoProfile -Command '$PSVersionTable.PSVersion'

      # Tunnel Windows -> Linux VM docker.sock (add your VM host/user as secrets)
      - name: Open SSH tunnel to Linux VM docker
        id: tunnel
        shell: pwsh
        run: |
          $p = Start-Process -NoNewWindow ssh `
            -PassThru `
            -ArgumentList @(
              "-o","ExitOnForwardFailure=yes",
              "-N","-L","23750:/var/run/docker.sock",
              "${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}"
            )
          Set-Content -Path "$env:RUNNER_TEMP\ssh_tunnel_pid.txt" -Value $p.Id
          Start-Sleep -Seconds 2

      - uses: docker/setup-buildx-action@v3
