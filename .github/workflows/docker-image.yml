name: Deploy Python App to Windows Server (no Docker)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, windows, x64]   # <-- your Windows runner labels
    env:
      APP_ROOT: C:\apps\myapp
      APP_TASK: MyPythonApp
      APP_PORT: 8080
      # Optional: set in repo secrets; defaults to "python main.py"
      START_CMD: ${{ secrets.APP_START }}
    steps:
      - uses: actions/checkout@v4

      - name: Ensure app directory
        shell: powershell
        run: |
          New-Item -ItemType Directory -Path $env:APP_ROOT -Force | Out-Null

      - name: Copy files to app directory
        shell: powershell
        run: |
          $src = "$env:GITHUB_WORKSPACE"
          $dst = "$env:APP_ROOT\src"
          New-Item -ItemType Directory -Path $dst -Force | Out-Null
          robocopy $src $dst /MIR /NFL /NDL /NP /NJH /NJS /XD .git .github .venv __pycache__ .pytest_cache .mypy_cache .vs .vscode Publish /XF Dockerfile docker-compose.yml
          if ($LASTEXITCODE -ge 8) { exit $LASTEXITCODE }

      - name: Install Python 3.12 for build
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Create/Update virtualenv and install deps
        shell: powershell
        run: |
          $venv = Join-Path $env:APP_ROOT '.venv'
          if (-not (Test-Path $venv)) { python -m venv $venv }
          & "$venv\Scripts\python.exe" -m pip install --upgrade pip wheel
          if (Test-Path "$env:APP_ROOT\src\requirements.txt") {
            & "$venv\Scripts\python.exe" -m pip install -r "$env:APP_ROOT\src\requirements.txt"
          } else { Write-Host "No requirements.txt foundâ€”skipping." }

      - name: Write .env (optional)
        if: ${{ secrets.APP_ENV != '' }}
        shell: powershell
        run: |
          Set-Content -Path "$env:APP_ROOT\src\.env" -Value @"${{ secrets.APP_ENV }}


      - name: Create run.ps1 (launcher)
        shell: powershell
        run: |
          $appRoot = $env:APP_ROOT
          $port    = $env:APP_PORT
          $start   = if ([string]::IsNullOrWhiteSpace($env:START_CMD)) { 'python main.py' } else { $env:START_CMD }

          $lines = @()
          $lines += "$ErrorActionPreference = 'Stop'"
          $lines += "Set-Location '$appRoot\src'"
          $lines += ""
          $lines += "if (-not `$env:PORT) { `$env:PORT = '$port' }"
          $lines += ""
          $lines += 'if (Test-Path ".env") {'
          $lines += '  Get-Content ".env" | ForEach-Object {'
          $lines += "    if (`$_ -match '^\s*#') { return }"
          $lines += "    if (`$_ -match '^\s*$') { return }"
          $lines += "    `$key,`$val = `$_ -split '=', 2"
          $lines += '    [System.Environment]::SetEnvironmentVariable($key.Trim(), $val.Trim())'
          $lines += '  }'
          $lines += '}'
          $lines += ""
          $lines += "& '$appRoot\.venv\Scripts\python.exe' -c ""import os,sys;print('Python:',sys.version);print('CWD:',os.getcwd())"""
          $lines += "& '$appRoot\.venv\Scripts\python.exe' $start"
          $out = $lines -join "`r`n"
          Set-Content -Path "$appRoot\run.ps1" -Value $out -Encoding UTF8

      - name: Register/Update Scheduled Task (run at startup)
        shell: powershell
        run: |
          $exe  = "$env:WINDIR\System32\WindowsPowerShell\v1.0\powershell.exe"
          $args = "-NoProfile -ExecutionPolicy Bypass -File `"$env:APP_ROOT\run.ps1`""
          $action    = New-ScheduledTaskAction -Execute $exe -Argument $args -WorkingDirectory $env:APP_ROOT
          $trigger   = New-ScheduledTaskTrigger -AtStartup
          $principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
          $settings  = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -RestartCount 5 -RestartInterval (New-TimeSpan -Minutes 1)

          $exists = Get-ScheduledTask -TaskName $env:APP_TASK -ErrorAction SilentlyContinue
          if ($exists) { Unregister-ScheduledTask -TaskName $env:APP_TASK -Confirm:$false }
          Register-ScheduledTask -TaskName $env:APP_TASK -Action $action -Trigger $trigger -Principal $principal -Settings $settings | Out-Null

      - name: Restart app
        shell: powershell
        run: |
          schtasks /end /tn $env:APP_TASK 2>$null | Out-Null
          Start-ScheduledTask -TaskName $env:APP_TASK
          Start-Sleep -Seconds 2
          schtasks /query /tn $env:APP_TASK /v /fo LIST

      - name: Ensure firewall rule
        shell: powershell
        run: |
          $name = "MyApp Port $env:APP_PORT"
          if (-not (Get-NetFirewallRule -DisplayName $name -ErrorAction SilentlyContinue)) {
            New-NetFirewallRule -DisplayName $name -Direction Inbound -Action Allow -Protocol TCP -LocalPort $env:APP_PORT | Out-Null
          }
