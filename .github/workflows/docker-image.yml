name: Build on Remote Linux Docker from Windows Runner (pwsh)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-run:
    runs-on: [self-hosted, windows, x64]  # <- your Windows runner labels
    env:
      REMOTE_DOCKER: tcp://127.0.0.1:23750
    steps:
      - uses: actions/checkout@v4

     # Install PowerShell 7 if missing (no version hardcoding)
      - name: Ensure PowerShell 7
        shell: powershell
        run: |
          if (-not (Get-Command pwsh -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            iex "& { $(irm https://aka.ms/install-powershell.ps1) } -UseMSI -Quiet"
          }
          pwsh -NoLogo -NoProfile -Command '$PSVersionTable.PSVersion'

          
      # Tunnel Windows -> Linux VM docker.sock (add your VM host/user as secrets)
      - name: Open SSH tunnel to Linux VM docker
        id: tunnel
        shell: pwsh
        run: |
          $p = Start-Process -NoNewWindow ssh `
            -PassThru `
            -ArgumentList @(
              "-o","ExitOnForwardFailure=yes",
              "-N","-L","23750:/var/run/docker.sock",
              "${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}"
            )
          Set-Content -Path "$env:RUNNER_TEMP\ssh_tunnel_pid.txt" -Value $p.Id
          Start-Sleep -Seconds 2

      - uses: docker/setup-buildx-action@v3
