name: Deploy Python App to Windows Server (no Docker)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: [self-hosted, windows, x64]  # your Windows runner labels
    env:
      APP_ROOT: C:\apps\myapp
      APP_TASK: MyPythonApp
      APP_PORT: 8080
    steps:
      - uses: actions/checkout@v4

      # OPTIONAL: keep if you want pwsh available; otherwise remove this step.
      - name: Ensure PowerShell 7 (pwsh)
        shell: powershell
        run: |
          $pwsh = Join-Path $env:ProgramFiles 'PowerShell\7\pwsh.exe'
          if (-not (Test-Path $pwsh)) {
            Write-Host "Installing PowerShell 7..."
            Set-ExecutionPolicy Bypass -Scope Process -Force
            iex "& { $(irm https://aka.ms/install-powershell.ps1) } -UseMSI -Quiet"
          }

      # Ensure app directory exists
      - name: Create app directory
        shell: powershell
        run: |
          New-Item -ItemType Directory -Path $env:APP_ROOT -Force | Out-Null

      # Sync repo files into APP_ROOT (robust & fast; excludes junk)
      - name: Copy files to app directory
        shell: powershell
        run: |
          $src = "$env:GITHUB_WORKSPACE"
          $dst = "$env:APP_ROOT\src"
          New-Item -ItemType Directory -Path $dst -Force | Out-Null
          # Mirror source -> dest, excluding typical non-runtime dirs
          robocopy $src $dst /MIR /NFL /NDL /NP /NJH /NJS /XD .git .github .venv __pycache__ .pytest_cache .mypy_cache .vs .vscode Publish /XF Dockerfile docker-compose.yml

      # Ensure Python (prefers existing Python; falls back to setup-python for build-time)
      - name: Locate or setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      # From here on, use the job's Python to create a persistent venv in APP_ROOT

      - name: Create/Update virtualenv
        shell: powershell
        working-directory: ${{ env.APP_ROOT }}
        run: |
          $venv = Join-Path $env:APP_ROOT '.venv'
          if (-not (Test-Path $venv)) {
            python -m venv $venv
          }
          & "$venv\Scripts\python.exe" -m pip install --upgrade pip wheel
          if (Test-Path "$env:APP_ROOT\src\requirements.txt") {
            & "$venv\Scripts\python.exe" -m pip install -r "$env:APP_ROOT\src\requirements.txt"
          } else {
            Write-Host "No requirements.txt foundâ€”skipping dependency install."
          }

      # Optional: write an .env file from a secret (if you use dotenv)
      # Add a secret APP_ENV (multi-line KEY=VALUE) if needed.
      - name: Write .env (optional)
        if: ${{ secrets.APP_ENV != '' }}
        shell: powershell
        working-directory: ${{ env.APP_ROOT }}
        run: |
          Set-Content -Path "$env:APP_ROOT\src\.env" -Value @"
${{ secrets.APP_ENV }}
"@ -Encoding ascii

      # Create a run.ps1 that launches your app from the venv
      - name: Create run.ps1
        shell: powershell
        working-directory: ${{ env.APP_ROOT }}
        env:
          START_CMD: ${{ secrets.APP_START }}
        run: |
          $venvPy = "$env:APP_ROOT\.\.venv\Scripts\python.exe" -replace '\\\.\.', ''  # normalize path
          $start = if ([string]::IsNullOrWhiteSpace($env:START_CMD)) { 'python main.py' } else { $env:START_CMD }
          $script = @"
# Auto-generated by CI
`$ErrorActionPreference = 'Stop'
Set-Location "$env:APP_ROOT\src"

# Export a PORT env var if you use it
if (-not `$env:PORT) { `$env:PORT = "$env:APP_PORT" }

# If there's a .env, load it (simple KEY=VALUE lines)
if (Test-Path ".env") {
  Get-Content ".env" | ForEach-Object {
    if (`$_ -match '^\s*#') { return }
    if (`$_ -match '^\s*$') { return }
    `$key,`$val = `$_ -split '=', 2
    [System.Environment]::SetEnvironmentVariable(`$key.Trim(), `$val.Trim())
  }
}

# Launch the app
& "$env:APP_ROOT\.venv\Scripts\python.exe" -c "import os,sys;print('Python:',sys.version);print('CWD:',os.getcwd())" | Write-Host
& "$env:APP_ROOT\.venv\Scripts\python.exe" $start
"@
          Set-Content -Path "$env:APP_ROOT\run.ps1" -Value $script -Encoding UTF8

      # Create/Update a Scheduled Task that runs the app at startup under LocalSystem
      - name: Register/Update Scheduled Task
        shell: powershell
        run: |
          $task = Get-ScheduledTask -TaskName $env:APP_TASK -ErrorAction SilentlyContinue
          $exe  = "$env:WINDIR\System32\WindowsPowerShell\v1.0\powershell.exe"
          $args = "-NoProfile -ExecutionPolicy Bypass -File `"$env:APP_ROOT\run.ps1`""

          $action    = New-ScheduledTaskAction -Execute $exe -Argument $args -WorkingDirectory $env:APP_ROOT
          $trigger   = New-ScheduledTaskTrigger -AtStartup
          $principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
          $settings  = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -RestartCount 5 -RestartInterval (New-TimeSpan -Minutes 1)
          
          if ($task) {
            Unregister-ScheduledTask -TaskName $env:APP_TASK -Confirm:$false
          }
          Register-ScheduledTask -TaskName $env:APP_TASK -Action $action -Trigger $trigger -Principal $principal -Settings $settings | Out-Null

      # Stop the currently running instance (if any), then start the updated task
      - name: Restart app
        shell: powershell
        run: |
          schtasks /end /tn $env:APP_TASK 2>$null | Out-Null
          Start-ScheduledTask -TaskName $env:APP_TASK
          Start-Sleep -Seconds 2
          schtasks /query /tn $env:APP_TASK /v /fo LIST

      # Open firewall for APP_PORT (idempotent)
      - name: Ensure firewall rule
        shell: powershell
        run: |
          $rule = Get-NetFirewallRule -DisplayName "MyApp Port $env:APP_PORT" -ErrorAction SilentlyContinue
          if (-not $rule) {
            New-NetFirewallRule -DisplayName "MyApp Port $env:APP_PORT" -Direction Inbound -Action Allow -Protocol TCP -LocalPort $env:APP_PORT | Out-Null
          }
